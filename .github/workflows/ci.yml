name: CI & Quality Check (Build & Sokrates)

on:
  push:
    branches: ["main", "master", "fix/**"]
  pull_request:
    branches: ["main", "master"]

jobs:
  build-and-analyze:
    name: Build & Quality Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Important pour l'historique Sokrates

      # 1. SETUP ENVIRONNEMENT
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'

      - name: Setup Java (pour Sokrates)
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      # 2. INSTALLATION DES DÉPENDANCES
      - name: Install root dependencies
        run: npm install

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm install

      - name: Install frontend (SPL) dependencies
        working-directory: ./SPL
        run: npm install

      # 3. GÉNÉRATION ET BUILD (Vérifie que le projet fonctionne/compile)
      - name: Generate Prisma Client
        working-directory: ./backend
        run: |
          # Génère le client Prisma pour vérifier que le schéma est valide
          # Pas besoin de DB active ici, juste de la génération de code
          npx prisma generate

      - name: Build Frontend
        working-directory: ./SPL
        run: |
          # Vérifie que le frontend compile correctement (Vite build)
          npm run build

      # 4. ANALYSE DE QUALITÉ SOKRATES
      - name: Download Sokrates
        run: |
          mkdir -p ./sokrates
          cd ./sokrates
          # URL officielle via CloudFront
          curl -L https://d2bb1mtyn3kglb.cloudfront.net/builds/sokrates-LATEST.jar \
               -o sokrates-LATEST.jar
          cd ..

      - name: Generate Sokrates Report
        run: |
          ls -lh ./sokrates/sokrates-LATEST.jar
          java -jar ./sokrates/sokrates-LATEST.jar generateReports \
            -confFile "./_sokrates/config.json" \
            -outputFolder "./_sokrates/reports"

      - name: Upload Sokrates Report
        uses: actions/upload-artifact@v4
        with:
          name: sokrates-quality-report
          path: _sokrates/reports/html/
          retention-days: 7